<html>
<head>
  <title>México - Mapa</title>
  <meta charset="UTF-8">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.css"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.3/leaflet.js"></script>
  <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <style>
    #map{height: 100%; width: 60%;}
  </style>

</head>
<body>

  <div id="map">
  </div>

<div class="relative mb-6">
    <label for="labels-range-input" class="sr-only">Labels range</label>
    <input id="labels-range-input" type="range" value="2015" min="2015" max="2025" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
    <span class="text-sm text-gray-500 dark:text-gray-400 absolute start-0 -bottom-6">Min (2015)</span>
    <span class="text-sm text-gray-500 dark:text-gray-400 absolute start-0 -bottom-6">Current </span>
    <span class="text-sm text-gray-500 dark:text-gray-400 absolute end-0 -bottom-6">Max (2035)</span>
</div>
		


  <script>
		const rangeInput = document.getElementById('labels-range-input');
var map = new L.Map("map", {center: [19.4326, -99.13], zoom: 5})
    .addLayer(new L.TileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"));

// Variables for layer management
var currentGeoJsonLayer = null;
var municipalitiesData = null;
var year = 2015;

// Load states (base layer)
$.getJSON("static/states.geojson", function(data) {
    L.geoJson(data, {
        style: {
            color: '#666',
            weight: 1,
            fillOpacity: 0
        }
    }).addTo(map);
});

// Load municipalities data
$.getJSON("/static/municipalities.geojson", function(data) {
    console.log("Municipalities data loaded", data);
    municipalitiesData = data;
    updateMapWithYear(year); // Initial render
}).fail(function() {
    console.error("Failed to load municipalities GeoJSON");
});

// Slider event handler
rangeInput.addEventListener('input', function(event) {
    year = event.target.value;
    console.log("Year changed to:", year);
    updateMapWithYear(year);
});

function updateMapWithYear(selectedYear) {
    if (!municipalitiesData) {
        console.warn("Data not loaded yet");
        return;
    }

    // Remove previous layer if exists
    if (currentGeoJsonLayer) {
        map.removeLayer(currentGeoJsonLayer);
    }

    // Create new layer with current year
    currentGeoJsonLayer = L.geoJson(municipalitiesData, {
        style: function(feature) {
            const props = feature.properties;
            const month = "4";
            const value = props.violence?.[selectedYear]?.[month] ?? 0;
            
            // Calculate color based on value
            const color = getColorForValue(value);
            
            return {
                color: "#fff",
                weight: 0.2,
                fillColor: color,
                fillOpacity: 0.7
            };
        },
        onEachFeature: function(feature, layer) {
            const props = feature.properties;
            const month = "4";
            const value = props.violence?.[selectedYear]?.[month] ?? "Sin datos";

            layer.bindPopup(
                `<strong>${props.mun_name}</strong><br/>
                 Código: ${props.mun_code}<br/>
                 Estado: ${props.state_code}<br/>
                 IDM NM (${selectedYear}-${month}): ${value}`
            );
        }
    }).addTo(map);
}

function getColorForValue(value) {
    if (value === "Sin datos") return "#CCCCCC"; // Gray for missing data
    
    const numericValue = Number(value);
    if (isNaN(numericValue)) return "#CCCCCC"; // Gray if not a number
    
    // Value range: 0-2000 (50 = green, 2000 = red)
    const min = 50;
    const max = 2000;
    
    // If ≤ 50 → Green
    if (numericValue <= min) return "#4CAF50";
    
    // If ≥ 2000 → Red
    if (numericValue >= max) return "#F44336";
    
    // Intermediate values (50-2000) → Gradient from green to red
    const ratio = (numericValue - min) / (max - min);
    
    // RGB components for gradient
    const r = Math.floor(76 + (244 - 76) * ratio); // Green (76) → Red (244)
    const g = Math.floor(175 + (67 - 175) * ratio); // Green (175) → Red (67)
    const b = Math.floor(80 + (54 - 80) * ratio);   // Green (80) → Red (54)
    
    return `rgb(${r}, ${g}, ${b})`;
}
  </script>
  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>
</html>
